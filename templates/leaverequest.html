<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    {% include 'header.html' %}
    <!-- Include jQuery and Bootstrap Datepicker -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <style>
        .col-md-8 {
            margin-left: 260px;

        }

        .card.mb-4 {
            margin-left: 260px;
        }

        /* Adjust row size for leave type, start date, end date */
        .card-body .table-responsive .form-group {
            margin-bottom: 1px;
            /* Increase this value to increase the row size */
        }

        #error-message {
            margin: 10px 0;
            /* Space above and below the error message */
            padding: 10px;
            /* Padding inside the error message box */
            border: 1px solid #dc3545;
            /* Red border */
            background-color: #f8d7da;
            /* Light red background */
            color: #721c24;
            /* Dark red text */
            border-radius: 5px;
            /* Rounded corners */
            font-weight: bold;
            /* Make the text bold */
            display: none;
            /* Initially hidden */
        }
        .fontsz{
            font-size: 16px;
        }
    </style>
</head>

<body class="g-sidenav-show   bg-gray-100">
    <div class="min-height-300 bg-primary position-absolute w-100" style="margin: 0px;"></div>

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12 " style="width: 90%;">
                <div class="card mb-4">
                    <div class="card-header pb-0">
                        <h6 class="fontsz">Leave Request</h6>
                    </div>
                    <div class="card-body px-0 pt-0 pb-2">
                        <div class="table-responsive p-0">
                            <form id="leaveForm" method="POST">
                                <table class="table align-items-center mb-0">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th
                                                class="text-uppercase text-secondary text-sm font-weight-bolder opacity-7 ps-2">
                                                Leave Type</th>
                                            <th
                                                class="text-uppercase text-secondary text-sm font-weight-bolder opacity-7 ps-2">
                                                Reason</th>
                                            <th
                                                class="text-uppercase text-secondary text-sm font-weight-bolder opacity-7 ps-2">
                                                Start Date</th>
                                            <th
                                                class="text-uppercase text-secondary text-sm font-weight-bolder opacity-7 ps-2">
                                                End Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td></td>
                                            <td class="justify-content-center">
                                                <select class="form-control fontsz" name="leave_type" id="leave_type">
                                                    <option value="">Select Leave Type</option>
                                                    <option value="sick">Sick Leave</option>
                                                    <option value="casual">Casual Leave</option>
                                                </select>
                                            </td>
                                            <td class="justify-content-center fontsz">
                                                <textarea class="form-control" name="reason" rows="5" cols="30"
                                                    placeholder="Reason" id="reason" required></textarea>
                                            </td>
                                            <td class="justify-content-center fontsz">
                                                <input class="form-control" type="text" name="start_date"
                                                    id="start_date" placeholder="Select Start Date" readonly required>
                                            </td>
                                            <td class="justify-content-center fontsz">
                                                <input class="form-control" type="text" name="end_date" id="end_date"
                                                    placeholder="Select End Date" readonly required>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="5">
                                                <div class="justify-content-center fontsz">
                                                    <button class="btn btn-primary btn-sm ms-auto" type="submit"
                                                        id="submitBtn" disabled>Request</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="5">
                                                <!-- Error Message Display -->
                                                {% if error_message %}
                                                <div id="error-message" class="alert alert-danger fontsz"
                                                    style="display: block;">
                                                    {{ error_message }}
                                                </div>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- leave table -->
    <div class="row">
        <div class="col-12" style="margin: 30px; width: 90%;">
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h6>Leaves List</h6>
                </div>
                <div class="card-body px-0 pt-0 pb-2">
                    <div class="table-responsive p-0">
                        <table class="table align-items-center mb-0">
                            <form action="/empleave"></form>
                            <thead>

                                <tr>
                                    <th></th>
                                    <th
                                        class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                                        Sl.No</th>
                                    <th
                                        class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                                        Leave
                                        Type
                                    </th>
                                    <th
                                        class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                                        Start
                                        Date
                                    </th>
                                    <th
                                        class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                                        End Date
                                    </th>
                                    <th
                                        class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                                        Reason
                                    </th>
                                    <th
                                        class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                                        Status
                                    </th>
                                    <th
                                        class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                                        Days
                                    </th>

                                </tr>
                            </thead>
                            <tbody>
                                {% for leave in leaves %}
                                <tr>
                                    <td></td>
                                    <td class="justify-content-center ">{{ loop.index }}</td>
                                    <td class="justify-content-center ">{{ leave[2] }}
                                    </td>
                                    <td class="justify-content-center ">
                                        {{ leave[3] }}
                                    </td>
                                    <td class="justify-content-center ">
                                        {{ leave[4] }} </td>
                                    <td class="justify-content-center ">
                                        {{ leave[5] }} </td>
                                    <td class="justify-content-center " style="font-weight:bold;"
                                        data-status="{{ leave[6] }}">
                                        {{ leave[6] }} </td>
                                    <td id="daysDifference"></td> <!-- Difference will be displayed here -->
                                </tr>
                                <tr></tr>
                                <tr></tr>
                                {% endfor %}

                            </tbody>
                            </form>
                        </table>
                    </div>

                </div>
            </div>
        </div>
        <!-- Footer -->

    </div>
    </main>

    <!--   Core JS Files   -->
    <script src="static/assets/js/core/popper.min.js"></script>
    <script src="static/assets/js/core/bootstrap.min.js"></script>
    <script src="static/assets/js/plugins/perfect-scrollbar.min.js"></script>
    <script src="static/assets/js/plugins/smooth-scrollbar.min.js"></script>


    <script>
        $(document).ready(function () {
            // Initialize datepicker with dd/mm/yyyy format
            $('#start_date').datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true
            }).on('changeDate', function (e) {
                $('#end_date').datepicker('setStartDate', e.date); // Set minimum end date
                checkFields();
            });

            $('#end_date').datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true
            }).on('changeDate', function (e) {
                checkFields();
            });

            // Function to check if all fields are filled
            function checkFields() {
                const leaveType = $('#leave_type').val();
                const startDate = $('#start_date').val();
                const endDate = $('#end_date').val();
                const reason = $('#reason').val();

                // Enable the button if all fields are filled
                if (leaveType && startDate && endDate && reason) {
                    $('#submitBtn').prop('disabled', false);
                } else {
                    $('#submitBtn').prop('disabled', true);
                }
            }

            // Initial check on page load
            checkFields();
        });
    </script>
    <script>
        function calculateDaysDifference(startDate, endDate) {
            // Create Date objects
            const start = new Date(startDate);
            const end = new Date(endDate);

            // Calculate the difference in milliseconds
            const differenceInMilliseconds = end - start;

            // Convert milliseconds to days
            const millisecondsInADay = 1000 * 60 * 60 * 24; // 1000 ms/sec * 60 sec/min * 60 min/hr * 24 hr/day
            const differenceInDays = Math.round(differenceInMilliseconds / millisecondsInADay);

            return differenceInDays;
        }

        function showDaysDifference() {
            // Get all rows in the tbody
            const rows = document.querySelectorAll('tbody tr');

            // Iterate through each row
            rows.forEach(row => {
                const startDateCell = row.querySelector('td:nth-child(4)'); // Start Date column
                const endDateCell = row.querySelector('td:nth-child(5)');   // End Date column
                const daysDifferenceCell = row.querySelector('td:nth-child(8)'); // Days Difference column

                if (startDateCell && endDateCell && daysDifferenceCell) {
                    const start = startDateCell.innerText.trim(); // Retrieve and trim the start date
                    const end = endDateCell.innerText.trim();     // Retrieve and trim the end date

                    const daysDifference = calculateDaysDifference(start, end);

                    // Display the result in the days difference cell
                    daysDifferenceCell.innerText = daysDifference + 1 + " days";
                }
            });
        }

        // Call the function when the page loads
        window.onload = showDaysDifference;
    </script>


    <script>
        var win = navigator.platform.indexOf('Win') > -1;
        if (win && document.querySelector('#sidenav-scrollbar')) {
            var options = {
                damping: '0.5'
            }
            Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
        }
    </script>
    <!-- Github buttons -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
    <script src="static/assets/js/argon-dashboard.min.js?v=2.0.4"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get all cells with leave status
            const statusCells = document.querySelectorAll('td[data-status]');

            // Loop through each cell to set the color based on status
            statusCells.forEach(function (cell) {
                const status = cell.getAttribute('data-status');
                if (status === 'Approved') {
                    cell.style.color = 'green'; // Set color for approved status
                } else if (status === 'Rejected') {
                    cell.style.color = 'red'; // Set color for rejected status
                } else {
                    cell.style.color = 'grey'; // Default color for other statuses
                }
            });
        });
    </script>

</body>

</html>